@{
    ViewData["MostrarHeader"] = true;
}

@{
    ViewBag.Title = "Cronograma Semanal";
    Layout = "~/Views/Shared/_Layout.cshtml";

    Dictionary<DateTime, Dictionary<double, INFO_360.Models.Tarea>> agenda = ViewBag.AGENDA;
}
<section class="agenda">
    <div class="container py-4">
        <h2 class="text-center mb-4 st-title">Cronograma Semanal</h2>

        @if (agenda == null || agenda.Count == 0)
        {
            <div class="alert alert-warning text-center st-alert">
                No hay tareas programadas para los próximos 7 días.
            </div>
        }
        else
        {
            <div class="row justify-content-center">

                @foreach (DateTime dia in agenda.Keys.OrderBy(d => d))
                {
                    Dictionary<double, INFO_360.Models.Tarea> tareasDia = agenda[dia];

                    <div class="col-12 col-md-10 col-lg-8 mb-4">
                        <div class="card st-card shadow-sm">

                            <div class="card-header st-card-header">
                                <h4 class="m-0 st-card-title">
                                    @dia.ToString("dddd dd/MM/yyyy")
                                </h4>
                            </div>

                            <div class="card-body">

                                @if (tareasDia == null || tareasDia.Count == 0)
                                {
                                    <p class="text-muted text-center">No hay tareas asignadas para este día.</p>
                                }
                                else
                                {
                                    <div class="table-responsive">
                                        <table class="table table-borderless st-table">
                                            <thead>
                                                <tr>
                                                    <th>Hora</th>
                                                    <th>Tarea</th>
                                                    <th>Duración</th>
                                                </tr>
                                            </thead>

                                            <tbody>
@{
    // Obtener las horas ordenadas del día
    var horas = tareasDia.Keys.OrderBy(h => h).ToList();

    int i = 0;

    while (i < horas.Count)
    {
        double horaInicio = horas[i];
        Tarea tareaActual = tareasDia[horaInicio];

        if (tareaActual == null)
        {
            i++;
            continue;
        }

        // Avanzar mientras la misma tarea continúe en el horario
        double duracion = 0;
        int j = i;

        while (j < horas.Count && tareasDia[horas[j]] == tareaActual)
        {
            duracion += 0.25;
            j++;
        }

        // Convertir la hora a formato hh:mm
        int hE = (int)Math.Floor(horaInicio);
        int m = (int)((horaInicio - hE) * 60);

        <tr class="st-row">
            <td>@String.Format("{0:00}:{1:00}", hE, m)</td>
            <td>@tareaActual.Titulo</td>
            <td>@duracion h</td>
        </tr>

        i = j; // saltar al siguiente bloque de tarea distinta
    }
}
</tbody>
                                        </table>
                                    </div>
                                }

                            </div>
                        </div>
                    </div>
                }

            </div>
        }
    </div>
</section>